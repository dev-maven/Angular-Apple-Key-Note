import { getRange } from './shadow-dom-selection.helper';
export const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent) ||
    /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
export class SelectionHelper {
    get(container) {
        if (!container) {
            document.getSelection().removeAllRanges();
            return null;
        }
        const canvas = document.querySelector('pe-editor-canvas');
        const range = getRange(canvas.shadowRoot);
        if (!range) {
            return null;
        }
        const preSelectionRange = range.cloneRange();
        preSelectionRange.selectNodeContents(container);
        preSelectionRange.setEnd(range.startContainer, range.startOffset);
        const start = preSelectionRange.toString().length;
        return {
            start,
            end: start + range.toString().length,
            range,
            container,
            parentElement: range.endContainer.parentElement,
        };
    }
    restore(savedSelection) {
        if (!savedSelection) {
            return;
        }
        const doc = savedSelection.container.ownerDocument;
        const win = doc.defaultView;
        const range = doc.createRange();
        range.setStart(savedSelection.container, 0);
        range.collapse(true);
        const nodeStack = [savedSelection.container];
        let node;
        let foundStart = false;
        let stop = false;
        let charIndex = 0;
        while (!stop && (node = nodeStack.pop())) {
            if (node.nodeType == 3) {
                const nextCharIndex = charIndex + node.length;
                if (!foundStart &&
                    savedSelection.start >= charIndex &&
                    savedSelection.start <= nextCharIndex) {
                    range.setStart(node, savedSelection.start - charIndex);
                    foundStart = true;
                }
                if (foundStart &&
                    savedSelection.end >= charIndex &&
                    savedSelection.end <= nextCharIndex) {
                    range.setEnd(node, savedSelection.end - charIndex);
                    stop = true;
                }
                charIndex = nextCharIndex;
            }
            else {
                let i = node.childNodes.length;
                while (i--) {
                    nodeStack.push(node.childNodes[i]);
                }
            }
        }
        const selection = win.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
    }
    findParentTag(selection, tagName, className, searchDepth = 10) {
        let parentTag = null;
        if (!selection || !selection.anchorNode || !selection.focusNode) {
            return null;
        }
        const boundNodes = [
            selection.anchorNode,
            selection.focusNode,
        ];
        boundNodes.forEach(parent => {
            let searchDepthIterable = searchDepth;
            while (searchDepthIterable > 0 && parent.parentNode) {
                if (!tagName || parent.tagName === tagName) {
                    parentTag = parent;
                    if (className &&
                        parent.classList &&
                        !parent.classList.contains(className)) {
                        parentTag = null;
                    }
                    if (parentTag) {
                        break;
                    }
                }
                parent = parent.parentNode;
                searchDepthIterable--;
            }
        });
        return parentTag;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0aW9uLmhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BwZS9idWlsZGVyLXRleHQtZWRpdG9yLyIsInNvdXJjZXMiOlsiaGVscGVycy9zZWxlY3Rpb24uaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUV6RCxNQUFNLENBQUMsTUFBTSxRQUFRLEdBQUcsZ0NBQWdDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUM7SUFDaEYsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFFLE1BQWMsQ0FBQyxRQUFRLENBQUM7QUFFNUUsTUFBTSxPQUFPLGVBQWU7SUFDMUIsR0FBRyxDQUFDLFNBQWtCO1FBQ3BCLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDZCxRQUFRLENBQUMsWUFBWSxFQUFFLENBQUMsZUFBZSxFQUFFLENBQUM7WUFFMUMsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUVELE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUUxRCxNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRTFDLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDVixPQUFPLElBQUksQ0FBQztTQUNiO1FBRUQsTUFBTSxpQkFBaUIsR0FBVSxLQUFLLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDcEQsaUJBQWlCLENBQUMsa0JBQWtCLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDaEQsaUJBQWlCLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxjQUFjLEVBQUUsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ2xFLE1BQU0sS0FBSyxHQUFXLGlCQUFpQixDQUFDLFFBQVEsRUFBRSxDQUFDLE1BQU0sQ0FBQztRQUUxRCxPQUFPO1lBQ0wsS0FBSztZQUNMLEdB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QW1CLEdBQUcsV0FBVyxDQUFDO1lBRXRDLE9BQU8sbUJBQW1CLEdBQUcsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxVQUFVLEVBQUU7Z0JBQ25ELElBQUksQ0FBQyxPQUFPLElBQUksTUFBTSxDQUFDLE9BQU8sS0FBSyxPQUFPLEVBQUU7b0JBQzFDLFNBQVMsR0FBRyxNQUFNLENBQUM7b0JBRW5CLElBQ0UsU0FBUzt3QkFDVCxNQUFNLENBQUMsU0FBUzt3QkFDaEIsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsRUFDckM7d0JBQ0EsU0FBUyxHQUFHLElBQUksQ0FBQztxQkFDbEI7b0JBRUQsSUFBSSxTQUFTLEVBQUU7d0JBQ2IsTUFBTTtxQkFDUDtpQkFDRjtnQkFFRCxNQUFNLEdBQUcsTUFBTSxDQUFDLFVBQXlCLENBQUM7Z0JBQzFDLG1CQUFtQixFQUFFLENBQUM7YUFDdkI7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVkaXRvclNlbGVjdGlvbiB9IGZyb20gJy4uL3RleHQtZWRpdG9yLmludGVyZmFjZSc7XG5pbXBvcnQgeyBnZXRSYW5nZSB9IGZyb20gJy4vc2hhZG93LWRvbS1zZWxlY3Rpb24uaGVscGVyJztcblxuZXhwb3J0IGNvbnN0IGlzU2FmYXJpID0gL14oKD8hY2hyb21lfGFuZHJvaWQpLikqc2FmYXJpL2kudGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSB8fFxuICAvaVBhZHxpUGhvbmV8aVBvZC8udGVzdChuYXZpZ2F0b3IudXNlckFnZW50KSAmJiAhKHdpbmRvdyBhcyBhbnkpLk1TU3RyZWFtO1xuXG5leHBvcnQgY2xhc3MgU2VsZWN0aW9uSGVscGVyIHtcbiAgZ2V0KGNvbnRhaW5lcjogRWxlbWVudCk6IEVkaXRvclNlbGVjdGlvbiB7XG4gICAgaWYgKCFjb250YWluZXIpIHtcbiAgICAgIGRvY3VtZW50LmdldFNlbGVjdGlvbigpLnJlbW92ZUFsbFJhbmdlcygpO1xuXG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBjYW52YXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdwZS1lZGl0b3ItY2FudmFzJyk7XG5cbiAgICBjb25zdCByYW5nZSA9IGdldFJhbmdlKGNhbnZhcy5zaGFkb3dSb290KTtcblxuICAgIGlmICghcmFuZ2UpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IHByZVNlbGVjdGlvblJhbmdlOiBSYW5nZSA9IHJhbmdlLmNsb25lUmFuZ2UoKTtcbiAgICBwcmVTZWxlY3Rpb25SYW5nZS5zZWxlY3ROb2RlQ29udGVudHMoY29udGFpbmVyKTtcbiAgICBwcmVTZWxlY3Rpb25SYW5nZS5zZXRFbmQocmFuZ2Uuc3RhcnRDb250YWluZXIsIHJhbmdlLnN0YXJ0T2Zmc2V0KTtcbiAgICBjb25zdCBzdGFydDogbnVtYmVyID0gcHJlU2VsZWN0aW9uUmFuZ2UudG9TdHJpbmcoKS5sZW5ndGg7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3RhcnQsXG4gICAgICBlbmQ6IHN0YXJ0ICsgcmFuZ2UudG9TdHJpbmcoKS5sZW5ndGgsXG4gICAgICByYW5nZSxcbiAgICAgIGNvbnRhaW5lcixcbiAgICAgIHBhcmVudEVsZW1lbnQ6IHJhbmdlLmVuZENvbnRhaW5lci5wYXJlbnRFbGVtZW50LFxuICAgIH07XG4gIH1cblxuICByZXN0b3JlKHNhdmVkU2VsZWN0aW9uOiBFZGl0b3JTZWxlY3Rpb24pOiB2b2lkIHtcbiAgICBpZiAoIXNhdmVkU2VsZWN0aW9uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgZG9jOiBEb2N1bWVudCA9IHNhdmVkU2VsZWN0aW9uLmNvbnRhaW5lci5vd25lckRvY3VtZW50O1xuICAgIGNvbnN0IHdpbjogV2luZG93ID0gZG9jLmRlZmF1bHRWaWV3O1xuICAgIGNvbnN0IHJhbmdlOiBSYW5nZSA9IGRvYy5jcmVhdGVSYW5nZSgpO1xuICAgIHJhbmdlLnNldFN0YXJ0KHNhdmVkU2VsZWN0aW9uLmNvbnRhaW5lciwgMCk7XG4gICAgcmFuZ2UuY29sbGFwc2UodHJ1ZSk7XG4gICAgY29uc3Qgbm9kZVN0YWNrOiBFbGVtZW50W10gPSBbc2F2ZWRTZWxlY3Rpb24uY29udGFpbmVyXTtcbiAgICBsZXQgbm9kZTtcbiAgICBsZXQgZm91bmRTdGFydCA9IGZhbHNlO1xuICAgIGxldCBzdG9wID0gZmFsc2U7XG4gICAgbGV0IGNoYXJJbmRleCA9IDA7XG5cbiAgICB3aGlsZSAoIXN0b3AgJiYgKG5vZGUgPSBub2RlU3RhY2sucG9wKCkpKSB7XG4gICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PSAzKSB7XG4gICAgICAgIGNvbnN0IG5leHRDaGFySW5kZXggPSBjaGFySW5kZXggKyBub2RlLmxlbmd0aDtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICFmb3VuZFN0YXJ0ICYmXG4gICAgICAgICAgc2F2ZWRTZWxlY3Rpb24uc3RhcnQgPj0gY2hhckluZGV4ICYmXG4gICAgICAgICAgc2F2ZWRTZWxlY3Rpb24uc3RhcnQgPD0gbmV4dENoYXJJbmRleFxuICAgICAgICApIHtcbiAgICAgICAgICByYW5nZS5zZXRTdGFydChub2RlLCBzYXZlZFNlbGVjdGlvbi5zdGFydCAtIGNoYXJJbmRleCk7XG4gICAgICAgICAgZm91bmRTdGFydCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKFxuICAgICAgICAgIGZvdW5kU3RhcnQgJiZcbiAgICAgICAgICBzYXZlZFNlbGVjdGlvbi5lbmQgPj0gY2hhckluZGV4ICYmXG4gICAgICAgICAgc2F2ZWRTZWxlY3Rpb24uZW5kIDw9IG5leHRDaGFySW5kZXhcbiAgICAgICAgKSB7XG4gICAgICAgICAgcmFuZ2Uuc2V0RW5kKG5vZGUsIHNhdmVkU2VsZWN0aW9uLmVuZCAtIGNoYXJJbmRleCk7XG4gICAgICAgICAgc3RvcCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgY2hhckluZGV4ID0gbmV4dENoYXJJbmRleDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxldCBpID0gbm9kZS5jaGlsZE5vZGVzLmxlbmd0aDtcbiAgICAgICAgd2hpbGUgKGktLSkge1xuICAgICAgICAgIG5vZGVTdGFjay5wdXNoKG5vZGUuY2hpbGROb2Rlc1tpXSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBzZWxlY3Rpb24gPSB3aW4uZ2V0U2VsZWN0aW9uKCk7XG4gICAgc2VsZWN0aW9uLnJlbW92ZUFsbFJhbmdlcygpO1xuICAgIHNlbGVjdGlvbi5hZGRSYW5nZShyYW5nZSk7XG4gIH1cblxuICBmaW5kUGFyZW50VGFnKFxuICAgIHNlbGVjdGlvbjogU2VsZWN0aW9uLFxuICAgIHRhZ05hbWU/OiBzdHJpbmcsXG4gICAgY2xhc3NOYW1lPzogc3RyaW5nLFxuICAgIHNlYXJjaERlcHRoID0gMTAsIC8vIHRzbGludDpkaXNhYmxlLWxpbmU6dHlwZWRlZlxuICApOiBIVE1MRWxlbWVudCB8IG51bGwge1xuICAgIGxldCBwYXJlbnRUYWcgPSBudWxsO1xuXG4gICAgaWYgKCFzZWxlY3Rpb24gfHwgIXNlbGVjdGlvbi5hbmNob3JOb2RlIHx8ICFzZWxlY3Rpb24uZm9jdXNOb2RlKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBib3VuZE5vZGVzID0gW1xuICAgICAgc2VsZWN0aW9uLmFuY2hvck5vZGUgYXMgSFRNTEVsZW1lbnQsXG4gICAgICBzZWxlY3Rpb24uZm9jdXNOb2RlIGFzIEhUTUxFbGVtZW50LFxuICAgIF07XG5cbiAgICBib3VuZE5vZGVzLmZvckVhY2gocGFyZW50ID0+IHtcbiAgICAgIGxldCBzZWFyY2hEZXB0aEl0ZXJhYmxlID0gc2VhcmNoRGVwdGg7XG5cbiAgICAgIHdoaWxlIChzZWFyY2hEZXB0aEl0ZXJhYmxlID4gMCAmJiBwYXJlbnQucGFyZW50Tm9kZSkge1xuICAgICAgICBpZiAoIXRhZ05hbWUgfHwgcGFyZW50LnRhZ05hbWUgPT09IHRhZ05hbWUpIHtcbiAgICAgICAgICBwYXJlbnRUYWcgPSBwYXJlbnQ7XG5cbiAgICAgICAgICBpZiAoXG4gICAgICAgICAgICBjbGFzc05hbWUgJiZcbiAgICAgICAgICAgIHBhcmVudC5jbGFzc0xpc3QgJiZcbiAgICAgICAgICAgICFwYXJlbnQuY2xhc3NMaXN0LmNvbnRhaW5zKGNsYXNzTmFtZSlcbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIHBhcmVudFRhZyA9IG51bGw7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKHBhcmVudFRhZykge1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcGFyZW50ID0gcGFyZW50LnBhcmVudE5vZGUgYXMgSFRNTEVsZW1lbnQ7XG4gICAgICAgIHNlYXJjaERlcHRoSXRlcmFibGUtLTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBwYXJlbnRUYWc7XG4gIH1cbn1cbiJdfQ==