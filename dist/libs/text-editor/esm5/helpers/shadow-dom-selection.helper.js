var debug = false;
var hasShadow = 'attachShadow' in Element.prototype && 'getRootNode' in Element.prototype;
var hasSelection = !!(hasShadow && document.createElement('div').attachShadow({ mode: 'open' }).getSelection);
var hasShady = window.ShadyDOM && window.ShadyDOM.inUse;
var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent) ||
    /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
var useDocument = !hasShadow || hasShady || (!hasSelection && !isSafari);
var validNodeTypes = [Node.ELEMENT_NODE, Node.TEXT_NODE, Node.DOCUMENT_FRAGMENT_NODE];
function isValidNode(node) {
    return validNodeTypes.includes(node.nodeType);
}
function findNode(s, parentNode, isLeft) {
    var nodes = parentNode.childNodes || parentNode.children;
    if (!nodes) {
        return parentNode; // found it, probably text
    }
    for (var i = 0; i < nodes.length; ++i) {
        var j = isLeft ? i : (nodes.length - 1 - i);
        var childNode = nodes[j];
        if (!isValidNode(childNode)) {
            continue;
        }
        debug && console.debug('checking child', childNode, 'IsLeft', isLeft);
        if (s.containsNode(childNode, true)) {
            if (s.containsNode(childNode, false)) {
                debug && console.info('found child', childNode);
                return childNode;
            }
            debug && console.info('descending child', childNode);
            return findNode(s, childNode, isLeft);
        }
        debug && console.info(parentNode, 'does NOT contain', childNode);
    }
    return parentNode;
}
var addInternalListener = (function () {
    if (hasSelection || useDocument) {
        // getSelection exists or document API can be used
        document.addEventListener('selectionchange', function (ev) {
            document.dispatchEvent(new CustomEvent('-shadow-selectionchange'));
        });
        return function () { };
    }
    var withinInternals = false;
    var handlers = [];
    document.addEventListener('selectionchange', function (ev) {
        if (withinInternals) {
            return;
        }
        document.dispatchEvent(new CustomEvent('-shadow-selectionchange'));
        withinInternals = true;
        window.setTimeout(function () {
            withinInternals = false;
        }, 0);
        handlers.forEach(function (fn) { return fn(ev); });
    });
    return function (fn) { return handlers.push(fn); };
})();
var wasCaret = false;
var resolveTask = null;
addInternalListener(function (ev) {
    var s = window.getSelection();
    if (s.type === 'Caret') {
        wasCaret = true;
    }
    else if (wasCaret && !resolveTask) {
        resolveTask = Promise.resolve(true).then(function () {
            wasCaret = false;
            resolveTask = null;
        });
    }
});
function containsNextElement(s, node, walkForward) {
    var start = node;
    while (node = walkFromNode(node, walkForward)) {
        // walking (left) can contain our own parent, which we don't want
        if (!node.contains(start)) {
            break;
        }
    }
    if (!node) {
        return false;
    }
    // we look for Element as .containsNode says true for _every_ text node, and we only care about
    // elements themselves
    return node instanceof Element && s.containsNode(node, true);
}
function getSelectionDirection(s, leftNode, rightNode) {
    if (s.type !== 'Range') {
        return undefined; // no direction
    }
    var measure = function () { return s.toString().length; };
    var initialSize = measure();
    debug && console.info("initial selection: \"" + s.toString() + "\"");
    if (initialSize === 1 && wasCaret && leftNode === rightNode) {
        // nb. We need to reset a single selection as Safari _always_ tells us the cursor was dragged
        // left to right (maybe RTL on those devices).
        // To be fair, Chrome has the same bug.
        debug && console.debug('resetting size=1');
        s.extend(leftNode, 0);
        s.collapseToEnd();
        return undefined;
    }
    var updatedSize;
    // Try extending forward and seeing what happens.
    s.modify('extend', 'forward', 'character');
    updatedSize = measure();
    debug && console.info("forward selection: \"" + s.toString() + "\"");
    if (updatedSize > initialSize || containsNextElement(s, rightNode, true)) {
        debug && console.info('got forward >, moving right');
        s.modify('extend', 'backward', 'character');
        return true;
    }
    else if (updatedSize < initialSize || !s.containsNode(leftNode)) {
        debug && console.info('got forward <, moving left');
        s.modify('extend', 'backward', 'character');
        return false;
    }
    // Maybe we were at the end of something. Extend backwards.
    // TODO(samthor): We seem to be able to get away without the 'backwards' case.
    s.modify('extend', 'backward', 'character');
    updatedSize = measure();
    debug && console.info("backward selection: \"" + s.toString() + "\"");
    if (updatedSize > initialSize || containsNextElement(s, leftNode, false)) {
        debug && console.info('got backwards >, moving left');
        s.modify('extend', 'forward', 'character');
        return false;
    }
    else if (updatedSize < initialSize || !s.containsNode(rightNode)) {
        debug && console.info('got backwards <, moving right');
        s.modify('extend', 'forward', 'character');
        return true;
    }
    // This is likely a select-all.
    return undefined;
}
function walkFromNode(node, walkForward) {
    if (!walkForward) {
        return node.previousSibling || node.parentNode || null;
    }
    while (node) {
        if (node.nextSibling) {
            return node.nextSibling;
        }
        node = node.parentNode;
    }
    return null;
}
function walkTextFromNode(node, isLeft, s) {
    for (; node; node = walkFromNode(node, isLeft)) {
        if (node.nodeType !== Node.TEXT_NODE) {
            continue;
        }
        var t = node.textContent;
        if (isLeft) {
            if (s.length < t.length) {
                return { node: node, offset: s.length };
            }
            var prefix = s.substr(0, t.length);
            if (prefix !== t) {
                console.debug('unexpected string prefix', prefix, 'expected', t);
            }
            s = s.substr(t.length);
        }
        else {
            if (s.length < t.length) {
                return { node: node, offset: t.length - s.length };
            }
            var suffix = s.substr(s.length - t.length);
            if (suffix !== t) {
                console.debug('unexpected string suffix', suffix, 'expected', t);
            }
            s = s.substr(0, s.length - t.length);
        }
    }
    return null; // too far
}
function initialSpace(node) {
    if (node.nodeType !== Node.TEXT_NODE) {
        return 0;
    }
    return /^\s*/.exec(node.textContent)[0].length;
}
function ignoredTrailingSpace(node) {
    if (node.nodeType !== Node.TEXT_NODE) {
        return 0;
    }
    var trailingSpaceCount = /\s*$/.exec(node.textContent)[0].length;
    if (!trailingSpaceCount) {
        return 0;
    }
    return trailingSpaceCount - 1; // always allow single last
}
var cachedRange = new Map();
export function getRange(root) {
    if (hasSelection || useDocument) {
        var s = (useDocument ? document : root).getSelection();
        return s.rangeCount ? s.getRangeAt(0) : null;
    }
    var thisFrame = cachedRange.get(root);
    if (thisFrame) {
        return thisFrame;
    }
    var initialText = window.getSelection().toString();
    var result = internalGetShadowSelection(root);
    var rs = result.range && result.range.toString() || null;
    if (rs !== null && rs !== initialText) {
        // TODO: sometimes triggers on single-char hack etc
        if (rs.replace(/\s/g, '') !== initialText.replace(/\s/g, '')) {
            // nb. selection eats initial/ending space, range does not: if whitespace is the only
            // difference, then ignore
            console.warn('invalid range, initial text:', initialText);
            console.warn('vs', rs, result.mode, result.range);
        }
    }
    cachedRange.set(root, result.range);
    window.setTimeout(function () {
        cachedRange.delete(root);
    }, 0);
    debug && console.debug('getRange got', result);
    return result.range;
}
var fakeSelectionNode = document.createTextNode('');
export function internalGetShadowSelection(root) {
    var range = document.createRange();
    var s = window.getSelection();
    // if (!s.containsNode(root.host, true)) {
    //   return {range: null, mode: 'none'};
    // }
    // TODO: inserting fake nodes isn't ideal, but containsNode doesn't work on nearby adjacent
    // text nodes (in fact it returns true for all text nodes on the page?!).
    // insert a fake 'before' node to see if it's selected
    root.insertBefore(fakeSelectionNode, root.childNodes[0]);
    var includesBeforeRoot = s.containsNode(fakeSelectionNode);
    fakeSelectionNode.remove();
    if (includesBeforeRoot) {
        return { range: null, mode: 'outside-before' };
    }
    // insert a fake 'after' node to see if it's selected
    root.appendChild(fakeSelectionNode);
    var includesAfterRoot = s.containsNode(fakeSelectionNode);
    fakeSelectionNode.remove();
    if (includesAfterRoot) {
        return { range: null, mode: 'outside-after' };
    }
    var measure = function () { return s.toString().length; };
    var initialSelectionContent = s.toString();
    if (!(s.type === 'Caret' || s.type === 'Range')) {
        return { range: null, mode: 'outside-after' };
    }
    var initialCaret = (s.type === 'Caret');
    var leftNode = findNode(s, root, true);
    var rightNode;
    var isNaturalDirection = undefined;
    if (s.type === 'Range') {
        rightNode = findNode(s, root, false); // get right node here _before_ getSelectionDirection
        isNaturalDirection = getSelectionDirection(s, leftNode, rightNode);
        // isNaturalDirection means "going right"
    }
    if (s.type === 'Caret') {
        // we might transition to being a caret, so don't check initial value
        s.extend(leftNode, 0);
        var at = measure();
        s.collapseToEnd();
        range.setStart(leftNode, at);
        range.setEnd(leftNode, at);
        return { range: range, mode: 'caret' };
    }
    else if (isNaturalDirection === undefined) {
        if (s.type !== 'Range') {
            throw new TypeError('unexpected type: ' + s.type);
        }
        // This occurs when we can't move because we can't extend left or right to measure the
        // direction we're moving in. Good news though: we don't need to _change_ the selection
        // to measure it, so just return immediately.
        range.setStart(leftNode, 0);
        range.setEnd(rightNode, rightNode.length);
        return { range: range, mode: 'all' };
    }
    var size = measure();
    var offsetLeft, offsetRight;
    // only one newline/space char is cared about
    var validRightLength = rightNode.length - ignoredTrailingSpace(rightNode);
    if (isNaturalDirection) {
        // walk in the opposite direction first
        s.extend(leftNode, 0);
        offsetLeft = measure() + initialSpace(leftNode); // measure doesn't include initial space
        // then in our actual direction
        s.extend(rightNode, validRightLength);
        offsetRight = validRightLength - (measure() - size);
        // then revert to the original position
        s.extend(rightNode, offsetRight);
    }
    else {
        // walk in the opposite direction first
        s.extend(rightNode, validRightLength);
        offsetRight = validRightLength - measure();
        // then in our actual direction
        s.extend(leftNode, 0);
        offsetLeft = measure() - size + initialSpace(leftNode); // doesn't include initial space
        // then revert to the original position
        s.extend(leftNode, offsetLeft);
    }
    if (debug) {
        if (leftNode === rightNode) {
            console.info('got string', leftNode.textContent.substr(offsetLeft, offsetRight - offsetLeft));
        }
        else {
            console.info('>>> string', leftNode.textContent.substr(offsetLeft));
            console.info('<<< string', rightNode.textContent.substr(0, offsetRight));
        }
    }
    range.setStart(leftNode, offsetLeft);
    range.setEnd(rightNode, offsetRight);
    return {
        mode: isNaturalDirection ? 'right' : 'left',
        range: range,
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhZG93LWRvbS1zZWxlY3Rpb24uaGVscGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHBlL2J1aWxkZXItdGV4dC1lZGl0b3IvIiwic291cmNlcyI6WyJoZWxwZXJzL3NoYWRvdy1kb20tc2VsZWN0aW9uLmhlbHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFNLEtBQUssR0FBRyxLQUFLLENBQUM7QUFFcEIsSUFBTSxTQUFTLEdBQUcsY0FBYyxJQUFJLE9BQU8sQ0FBQyxTQUFTLElBQUksYUFBYSxJQUFJLE9BQU8sQ0FBQyxTQUFTLENBQUM7QUFDNUYsSUFBTSxZQUFZLEdBQUcsQ0FBQyxDQUFDLENBQUMsU0FBUyxJQUFJLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUMsWUFBWSxDQUFDLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDaEgsSUFBTSxRQUFRLEdBQUksTUFBYyxDQUFDLFFBQVEsSUFBSyxNQUFjLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQztBQUM1RSxJQUFNLFFBQVEsR0FBRyxnQ0FBZ0MsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQztJQUN6RSxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUUsTUFBYyxDQUFDLFFBQVEsQ0FBQztBQUM1RSxJQUFNLFdBQVcsR0FBRyxDQUFDLFNBQVMsSUFBSSxRQUFRLElBQUksQ0FBQyxDQUFDLFlBQVksSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBRTNFLElBQU0sY0FBYyxHQUFHLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQ3hGLFNBQVMsV0FBVyxDQUFDLElBQUk7SUFDdkIsT0FBTyxjQUFjLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztB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LENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztJQUNyQyxLQUFLLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNyQyxPQUFPO1FBQ0wsSUFBSSxFQUFFLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU07UUFDM0MsS0FBSyxPQUFBO0tBQ04sQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBkZWJ1ZyA9IGZhbHNlO1xuXG5jb25zdCBoYXNTaGFkb3cgPSAnYXR0YWNoU2hhZG93JyBpbiBFbGVtZW50LnByb3RvdHlwZSAmJiAnZ2V0Um9vdE5vZGUnIGluIEVsZW1lbnQucHJvdG90eXBlO1xuY29uc3QgaGFzU2VsZWN0aW9uID0gISEoaGFzU2hhZG93ICYmIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLmF0dGFjaFNoYWRvdyh7IG1vZGU6ICdvcGVuJyB9KS5nZXRTZWxlY3Rpb24pO1xuY29uc3QgaGFzU2hhZHkgPSAod2luZG93IGFzIGFueSkuU2hhZHlET00gJiYgKHdpbmRvdyBhcyBhbnkpLlNoYWR5RE9NLmluVXNlO1xuY29uc3QgaXNTYWZhcmkgPSAvXigoPyFjaHJvbWV8YW5kcm9pZCkuKSpzYWZhcmkvaS50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpIHx8XG4gIC9pUGFkfGlQaG9uZXxpUG9kLy50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpICYmICEod2luZG93IGFzIGFueSkuTVNTdHJlYW07XG5jb25zdCB1c2VEb2N1bWVudCA9ICFoYXNTaGFkb3cgfHwgaGFzU2hhZHkgfHwgKCFoYXNTZWxlY3Rpb24gJiYgIWlzU2FmYXJpKTtcblxuY29uc3QgdmFsaWROb2RlVHlwZXMgPSBbTm9kZS5FTEVNRU5UX05PREUsIE5vZGUuVEVYVF9OT0RFLCBOb2RlLkRPQ1VNRU5UX0ZSQUdNRU5UX05PREVdO1xuZnVuY3Rpb24gaXNWYWxpZE5vZGUobm9kZSkge1xuICByZXR1cm4gdmFsaWROb2RlVHlwZXMuaW5jbHVkZXMobm9kZS5ub2RlVHlwZSk7XG59XG5cbmZ1bmN0aW9uIGZpbmROb2RlKHMsIHBhcmVudE5vZGUsIGlzTGVmdCkge1xuICBjb25zdCBub2RlcyA9IHBhcmVudE5vZGUuY2hpbGROb2RlcyB8fCBwYXJlbnROb2RlLmNoaWxkcmVuO1xuICBpZiAoIW5vZGVzKSB7XG4gICAgcmV0dXJuIHBhcmVudE5vZGU7ICAvLyBmb3VuZCBpdCwgcHJvYmFibHkgdGV4dFxuICB9XG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2Rlcy5sZW5ndGg7ICsraSkge1xuICAgIGNvbnN0IGogPSBpc0xlZnQgPyBpIDogKG5vZGVzLmxlbmd0aCAtIDEgLSBpKTtcbiAgICBjb25zdCBjaGlsZE5vZGUgPSBub2Rlc1tqXTtcbiAgICBpZiAoIWlzVmFsaWROb2RlKGNoaWxkTm9kZSkpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGRlYnVnICYmIGNvbnNvbGUuZGVidWcoJ2NoZWNraW5nIGNoaWxkJywgY2hpbGROb2RlLCAnSXNMZWZ0JywgaXNMZWZ0KTtcbiAgICBpZiAocy5jb250YWluc05vZGUoY2hpbGROb2RlLCB0cnVlKSkge1xuICAgICAgaWYgKHMuY29udGFpbnNOb2RlKGNoaWxkTm9kZSwgZmFsc2UpKSB7XG4gICAgICAgIGRlYnVnICYmIGNvbnNvbGUuaW5mbygnZm91bmQgY2hpbGQnLCBjaGlsZE5vZGUpO1xuICAgICAgICByZXR1cm4gY2hpbGROb2RlO1xuICAgICAgfVxuICAgICAgZGVidWcgJiYgY29uc29sZS5pbmZvKCdkZXNjZW5kaW5nIGNoaWxkJywgY2hpbGROb2RlKTtcbiAgICAgIHJldHVybiBmaW5kTm9kZShzLCBjaGlsZE5vZGUsIGlzTGVmdCk7XG4gICAgfVxuICAgIGRlYnVnICYmIGNvbnNvbGUuaW5mbyhwYXJlbnROb2RlLCAnZG9lcyBOT1QgY29udGFpbicsIGNoaWxkTm9kZSk7XG4gIH1cbiAgcmV0dXJuIHBhcmVudE5vZGU7XG59XG5cbmNvbnN0IGFkZEludGVybmFsTGlzdGVuZXIgPSAoKCkgPT4ge1xuICBpZiAoaGFzU2VsZWN0aW9uIHx8IHVzZURvY3VtZW50KSB7XG4gICAgLy8gZ2V0U2VsZWN0aW9uIGV4aXN0cyBvciBkb2N1bWVudCBBUEkgY2FuIGJlIHVzZWRcbiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdzZWxlY3Rpb25jaGFuZ2UnLCAoZXYpID0+IHtcbiAgICAgIGRvY3VtZW50LmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KCctc2hhZG93LXNlbGVjdGlvbmNoYW5nZScpKTtcbiAgICB9KTtcbiAgICByZXR1cm4gKCkgPT4ge307XG4gIH1cblxuICBsZXQgd2l0aGluSW50ZXJuYWxzID0gZmFsc2U7XG4gIGNvbnN0IGhhbmRsZXJzID0gW107XG5cbiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignc2VsZWN0aW9uY2hhbmdlJywgKGV2KSA9PiB7XG4gICAgaWYgKHdpdGhpbkludGVybmFscykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBkb2N1bWVudC5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnLXNoYWRvdy1zZWxlY3Rpb25jaGFuZ2UnKSk7XG4gICAgd2l0aGluSW50ZXJuYWxzID0gdHJ1ZTtcbiAgICB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB3aXRoaW5JbnRlcm5hbHMgPSBmYWxzZTtcbiAgICB9LCAwKTtcbiAgICBoYW5kbGVycy5mb3JFYWNoKChmbikgPT4gZm4oZXYpKTtcbiAgfSk7XG5cbiAgcmV0dXJuIChmbikgPT4gaGFuZGxlcnMucHVzaChmbik7XG59KSgpO1xuXG5sZXQgd2FzQ2FyZXQgPSBmYWxzZTtcbmxldCByZXNvbHZlVGFzayA9IG51bGw7XG5hZGRJbnRlcm5hbExpc3RlbmVyKChldikgPT4ge1xuICBjb25zdCBzID0gd2luZG93LmdldFNlbGVjdGlvbigpO1xuICBpZiAocy50eXBlID09PSAnQ2FyZXQnKSB7XG4gICAgd2FzQ2FyZXQgPSB0cnVlO1xuICB9IGVsc2UgaWYgKHdhc0NhcmV0ICYmICFyZXNvbHZlVGFzaykge1xuICAgIHJlc29sdmVUYXNrID0gUHJvbWlzZS5yZXNvbHZlKHRydWUpLnRoZW4oKCkgPT4ge1xuICAgICAgd2FzQ2FyZXQgPSBmYWxzZTtcbiAgICAgIHJlc29sdmVUYXNrID0gbnVsbDtcbiAgICB9KTtcbiAgfVxufSk7XG5cbmZ1bmN0aW9uIGNvbnRhaW5zTmV4dEVsZW1lbnQocywgbm9kZSwgd2Fsa0ZvcndhcmQpIHtcbiAgY29uc3Qgc3RhcnQgPSBub2RlO1xuICB3aGlsZSAobm9kZSA9IHdhbGtGcm9tTm9kZShub2RlLCB3YWxrRm9yd2FyZCkpIHtcbiAgICAvLyB3YWxraW5nIChsZWZ0KSBjYW4gY29udGFpbiBvdXIgb3duIHBhcmVudCwgd2hpY2ggd2UgZG9uJ3Qgd2FudFxuICAgIGlmICghbm9kZS5jb250YWlucyhzdGFydCkpIHtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuICBpZiAoIW5vZGUpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgLy8gd2UgbG9vayBmb3IgRWxlbWVudCBhcyAuY29udGFpbnNOb2RlIHNheXMgdHJ1ZSBmb3IgX2V2ZXJ5XyB0ZXh0IG5vZGUsIGFuZCB3ZSBvbmx5IGNhcmUgYWJvdXRcbiAgLy8gZWxlbWVudHMgdGhlbXNlbHZlc1xuICByZXR1cm4gbm9kZSBpbnN0YW5jZW9mIEVsZW1lbnQgJiYgcy5jb250YWluc05vZGUobm9kZSwgdHJ1ZSk7XG59XG5cbmZ1bmN0aW9uIGdldFNlbGVjdGlvbkRpcmVjdGlvbihzLCBsZWZ0Tm9kZSwgcmlnaHROb2RlKSB7XG4gIGlmIChzLnR5cGUgIT09ICdSYW5nZScpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkOyAgLy8gbm8gZGlyZWN0aW9uXG4gIH1cbiAgY29uc3QgbWVhc3VyZSA9ICgpID0+IHMudG9TdHJpbmcoKS5sZW5ndGg7XG5cbiAgY29uc3QgaW5pdGlhbFNpemUgPSBtZWFzdXJlKCk7XG4gIGRlYnVnICYmIGNvbnNvbGUuaW5mbyhgaW5pdGlhbCBzZWxlY3Rpb246IFwiJHtzLnRvU3RyaW5nKCl9XCJgKVxuXG4gIGlmIChpbml0aWFsU2l6ZSA9PT0gMSAmJiB3YXNDYXJldCAmJiBsZWZ0Tm9kZSA9PT0gcmlnaHROb2RlKSB7XG4gICAgLy8gbmIuIFdlIG5lZWQgdG8gcmVzZXQgYSBzaW5nbGUgc2VsZWN0aW9uIGFzIFNhZmFyaSBfYWx3YXlzXyB0ZWxscyB1cyB0aGUgY3Vyc29yIHdhcyBkcmFnZ2VkXG4gICAgLy8gbGVmdCB0byByaWdodCAobWF5YmUgUlRMIG9uIHRob3NlIGRldmljZXMpLlxuICAgIC8vIFRvIGJlIGZhaXIsIENocm9tZSBoYXMgdGhlIHNhbWUgYnVnLlxuICAgIGRlYnVnICYmIGNvbnNvbGUuZGVidWcoJ3Jlc2V0dGluZyBzaXplPTEnKTtcbiAgICBzLmV4dGVuZChsZWZ0Tm9kZSwgMCk7XG4gICAgcy5jb2xsYXBzZVRvRW5kKCk7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGxldCB1cGRhdGVkU2l6ZTtcblxuICAvLyBUcnkgZXh0ZW5kaW5nIGZvcndhcmQgYW5kIHNlZWluZyB3aGF0IGhhcHBlbnMuXG4gIHMubW9kaWZ5KCdleHRlbmQnLCAnZm9yd2FyZCcsICdjaGFyYWN0ZXInKTtcbiAgdXBkYXRlZFNpemUgPSBtZWFzdXJlKCk7XG4gIGRlYnVnICYmIGNvbnNvbGUuaW5mbyhgZm9yd2FyZCBzZWxlY3Rpb246IFwiJHtzLnRvU3RyaW5nKCl9XCJgKVxuXG4gIGlmICh1cGRhdGVkU2l6ZSA+IGluaXRpYWxTaXplIHx8IGNvbnRhaW5zTmV4dEVsZW1lbnQocywgcmlnaHROb2RlLCB0cnVlKSkge1xuICAgIGRlYnVnICYmIGNvbnNvbGUuaW5mbygnZ290IGZvcndhcmQgPiwgbW92aW5nIHJpZ2h0JylcbiAgICBzLm1vZGlmeSgnZXh0ZW5kJywgJ2JhY2t3YXJkJywgJ2NoYXJhY3RlcicpO1xuICAgIHJldHVybiB0cnVlO1xuICB9IGVsc2UgaWYgKHVwZGF0ZWRTaXplIDwgaW5pdGlhbFNpemUgfHwgIXMuY29udGFpbnNOb2RlKGxlZnROb2RlKSkge1xuICAgIGRlYnVnICYmIGNvbnNvbGUuaW5mbygnZ290IGZvcndhcmQgPCwgbW92aW5nIGxlZnQnKVxuICAgIHMubW9kaWZ5KCdleHRlbmQnLCAnYmFja3dhcmQnLCAnY2hhcmFjdGVyJyk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgLy8gTWF5YmUgd2Ugd2VyZSBhdCB0aGUgZW5kIG9mIHNvbWV0aGluZy4gRXh0ZW5kIGJhY2t3YXJkcy5cbiAgLy8gVE9ETyhzYW10aG9yKTogV2Ugc2VlbSB0byBiZSBhYmxlIHRvIGdldCBhd2F5IHdpdGhvdXQgdGhlICdiYWNrd2FyZHMnIGNhc2UuXG4gIHMubW9kaWZ5KCdleHRlbmQnLCAnYmFja3dhcmQnLCAnY2hhcmFjdGVyJyk7XG4gIHVwZGF0ZWRTaXplID0gbWVhc3VyZSgpO1xuICBkZWJ1ZyAmJiBjb25zb2xlLmluZm8oYGJhY2t3YXJkIHNlbGVjdGlvbjogXCIke3MudG9TdHJpbmcoKX1cImApXG5cbiAgaWYgKHVwZGF0ZWRTaXplID4gaW5pdGlhbFNpemUgfHwgY29udGFpbnNOZXh0RWxlbWVudChzLCBsZWZ0Tm9kZSwgZmFsc2UpKSB7XG4gICAgZGVidWcgJiYgY29uc29sZS5pbmZvKCdnb3QgYmFja3dhcmRzID4sIG1vdmluZyBsZWZ0JylcbiAgICBzLm1vZGlmeSgnZXh0ZW5kJywgJ2ZvcndhcmQnLCAnY2hhcmFjdGVyJyk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9IGVsc2UgaWYgKHVwZGF0ZWRTaXplIDwgaW5pdGlhbFNpemUgfHwgIXMuY29udGFpbnNOb2RlKHJpZ2h0Tm9kZSkpIHtcbiAgICBkZWJ1ZyAmJiBjb25zb2xlLmluZm8oJ2dvdCBiYWNrd2FyZHMgPCwgbW92aW5nIHJpZ2h0JylcbiAgICBzLm1vZGlmeSgnZXh0ZW5kJywgJ2ZvcndhcmQnLCAnY2hhcmFjdGVyJyk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvLyBUaGlzIGlzIGxpa2VseSBhIHNlbGVjdC1hbGwuXG4gIHJldHVybiB1bmRlZmluZWQ7XG59XG5cbmZ1bmN0aW9uIHdhbGtGcm9tTm9kZShub2RlLCB3YWxrRm9yd2FyZCkge1xuICBpZiAoIXdhbGtGb3J3YXJkKSB7XG4gICAgcmV0dXJuIG5vZGUucHJldmlvdXNTaWJsaW5nIHx8IG5vZGUucGFyZW50Tm9kZSB8fCBudWxsO1xuICB9XG4gIHdoaWxlIChub2RlKSB7XG4gICAgaWYgKG5vZGUubmV4dFNpYmxpbmcpIHtcbiAgICAgIHJldHVybiBub2RlLm5leHRTaWJsaW5nO1xuICAgIH1cbiAgICBub2RlID0gbm9kZS5wYXJlbnROb2RlO1xuICB9XG4gIHJldHVybiBudWxsO1xufVxuXG5mdW5jdGlvbiB3YWxrVGV4dEZyb21Ob2RlKG5vZGUsIGlzTGVmdCwgcykge1xuICBmb3IgKDsgbm9kZTsgbm9kZSA9IHdhbGtGcm9tTm9kZShub2RlLCBpc0xlZnQpKSB7XG4gICAgaWYgKG5vZGUubm9kZVR5cGUgIT09IE5vZGUuVEVYVF9OT0RFKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBjb25zdCB0ID0gbm9kZS50ZXh0Q29udGVudDtcbiAgICBpZiAoaXNMZWZ0KSB7XG4gICAgICBpZiAocy5sZW5ndGggPCB0Lmxlbmd0aCkge1xuICAgICAgICByZXR1cm4ge25vZGUsIG9mZnNldDogcy5sZW5ndGh9O1xuICAgICAgfVxuXG4gICAgICBjb25zdCBwcmVmaXggPSBzLnN1YnN0cigwLCB0Lmxlbmd0aCk7XG4gICAgICBpZiAocHJlZml4ICE9PSB0KSB7XG4gICAgICAgIGNvbnNvbGUuZGVidWcoJ3VuZXhwZWN0ZWQgc3RyaW5nIHByZWZpeCcsIHByZWZpeCwgJ2V4cGVjdGVkJywgdClcbiAgICAgIH1cblxuICAgICAgcyA9IHMuc3Vic3RyKHQubGVuZ3RoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHMubGVuZ3RoIDwgdC5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIHtub2RlLCBvZmZzZXQ6IHQubGVuZ3RoIC0gcy5sZW5ndGh9O1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzdWZmaXggPSBzLnN1YnN0cihzLmxlbmd0aCAtIHQubGVuZ3RoKTtcbiAgICAgIGlmIChzdWZmaXggIT09IHQpIHtcbiAgICAgICAgY29uc29sZS5kZWJ1ZygndW5leHBlY3RlZCBzdHJpbmcgc3VmZml4Jywgc3VmZml4LCAnZXhwZWN0ZWQnLCB0KVxuICAgICAgfVxuXG4gICAgICBzID0gcy5zdWJzdHIoMCwgcy5sZW5ndGggLSB0Lmxlbmd0aCk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG51bGw7ICAvLyB0b28gZmFyXG59XG5cbmZ1bmN0aW9uIGluaXRpYWxTcGFjZShub2RlKSB7XG4gIGlmIChub2RlLm5vZGVUeXBlICE9PSBOb2RlLlRFWFRfTk9ERSkge1xuICAgIHJldHVybiAwO1xuICB9XG4gIHJldHVybiAvXlxccyovLmV4ZWMobm9kZS50ZXh0Q29udGVudClbMF0ubGVuZ3RoO1xufVxuXG5mdW5jdGlvbiBpZ25vcmVkVHJhaWxpbmdTcGFjZShub2RlKSB7XG4gIGlmIChub2RlLm5vZGVUeXBlICE9PSBOb2RlLlRFWFRfTk9ERSkge1xuICAgIHJldHVybiAwO1xuICB9XG4gIGNvbnN0IHRyYWlsaW5nU3BhY2VDb3VudCA9ICAvXFxzKiQvLmV4ZWMobm9kZS50ZXh0Q29udGVudClbMF0ubGVuZ3RoO1xuICBpZiAoIXRyYWlsaW5nU3BhY2VDb3VudCkge1xuICAgIHJldHVybiAwO1xuICB9XG4gIHJldHVybiB0cmFpbGluZ1NwYWNlQ291bnQgLSAxOyAgLy8gYWx3YXlzIGFsbG93IHNpbmdsZSBsYXN0XG59XG5cbmNvbnN0IGNhY2hlZFJhbmdlID0gbmV3IE1hcCgpO1xuZXhwb3J0IGZ1bmN0aW9uIGdldFJhbmdlKHJvb3QpOiBSYW5nZSB7XG4gIGlmIChoYXNTZWxlY3Rpb24gfHwgdXNlRG9jdW1lbnQpIHtcbiAgICBjb25zdCBzID0gKHVzZURvY3VtZW50ID8gZG9jdW1lbnQgOiByb290KS5nZXRTZWxlY3Rpb24oKTtcbiAgICByZXR1cm4gcy5yYW5nZUNvdW50ID8gcy5nZXRSYW5nZUF0KDApIDogbnVsbDtcbiAgfVxuXG5cbiAgY29uc3QgdGhpc0ZyYW1lID0gY2FjaGVkUmFuZ2UuZ2V0KHJvb3QpO1xuICBpZiAodGhpc0ZyYW1lKSB7XG4gICAgcmV0dXJuIHRoaXNGcmFtZTtcbiAgfVxuXG4gIGNvbnN0IGluaXRpYWxUZXh0ID0gd2luZG93LmdldFNlbGVjdGlvbigpLnRvU3RyaW5nKCk7XG4gIGNvbnN0IHJlc3VsdCA9IGludGVybmFsR2V0U2hhZG93U2VsZWN0aW9uKHJvb3QpO1xuICBjb25zdCBycyA9IHJlc3VsdC5yYW5nZSAmJiByZXN1bHQucmFuZ2UudG9TdHJpbmcoKSB8fCBudWxsO1xuICBpZiAocnMgIT09IG51bGwgJiYgcnMgIT09IGluaXRpYWxUZXh0KSB7XG4gICAgLy8gVE9ETzogc29tZXRpbWVzIHRyaWdnZXJzIG9uIHNpbmdsZS1jaGFyIGhhY2sgZXRjXG5cbiAgICBpZiAocnMucmVwbGFjZSgvXFxzL2csICcnKSAhPT0gaW5pdGlhbFRleHQucmVwbGFjZSgvXFxzL2csICcnKSkge1xuICAgICAgLy8gbmIuIHNlbGVjdGlvbiBlYXRzIGluaXRpYWwvZW5kaW5nIHNwYWNlLCByYW5nZSBkb2VzIG5vdDogaWYgd2hpdGVzcGFjZSBpcyB0aGUgb25seVxuICAgICAgLy8gZGlmZmVyZW5jZSwgdGhlbiBpZ25vcmVcbiAgICAgIGNvbnNvbGUud2FybignaW52YWxpZCByYW5nZSwgaW5pdGlhbCB0ZXh0OicsIGluaXRpYWxUZXh0KTtcbiAgICAgIGNvbnNvbGUud2FybigndnMnLCBycywgcmVzdWx0Lm1vZGUsIHJlc3VsdC5yYW5nZSk7XG4gICAgfVxuICB9XG5cbiAgY2FjaGVkUmFuZ2Uuc2V0KHJvb3QsIHJlc3VsdC5yYW5nZSk7XG4gIHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcbiAgICBjYWNoZWRSYW5nZS5kZWxldGUocm9vdCk7XG4gIH0sIDApO1xuICBkZWJ1ZyAmJiBjb25zb2xlLmRlYnVnKCdnZXRSYW5nZSBnb3QnLCByZXN1bHQpO1xuXG4gIHJldHVybiByZXN1bHQucmFuZ2U7XG59XG5cbmNvbnN0IGZha2VTZWxlY3Rpb25Ob2RlID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoJycpO1xuZXhwb3J0IGZ1bmN0aW9uIGludGVybmFsR2V0U2hhZG93U2VsZWN0aW9uKHJvb3QpIHtcbiAgY29uc3QgcmFuZ2UgPSBkb2N1bWVudC5jcmVhdGVSYW5nZSgpO1xuXG4gIGNvbnN0IHMgPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7XG4gIC8vIGlmICghcy5jb250YWluc05vZGUocm9vdC5ob3N0LCB0cnVlKSkge1xuICAvLyAgIHJldHVybiB7cmFuZ2U6IG51bGwsIG1vZGU6ICdub25lJ307XG4gIC8vIH1cblxuICAvLyBUT0RPOiBpbnNlcnRpbmcgZmFrZSBub2RlcyBpc24ndCBpZGVhbCwgYnV0IGNvbnRhaW5zTm9kZSBkb2Vzbid0IHdvcmsgb24gbmVhcmJ5IGFkamFjZW50XG4gIC8vIHRleHQgbm9kZXMgKGluIGZhY3QgaXQgcmV0dXJucyB0cnVlIGZvciBhbGwgdGV4dCBub2RlcyBvbiB0aGUgcGFnZT8hKS5cblxuICAvLyBpbnNlcnQgYSBmYWtlICdiZWZvcmUnIG5vZGUgdG8gc2VlIGlmIGl0J3Mgc2VsZWN0ZWRcbiAgcm9vdC5pbnNlcnRCZWZvcmUoZmFrZVNlbGVjdGlvbk5vZGUsIHJvb3QuY2hpbGROb2Rlc1swXSk7XG4gIGNvbnN0IGluY2x1ZGVzQmVmb3JlUm9vdCA9IHMuY29udGFpbnNOb2RlKGZha2VTZWxlY3Rpb25Ob2RlKTtcbiAgZmFrZVNlbGVjdGlvbk5vZGUucmVtb3ZlKCk7XG4gIGlmIChpbmNsdWRlc0JlZm9yZVJvb3QpIHtcbiAgICByZXR1cm4ge3JhbmdlOiBudWxsLCBtb2RlOiAnb3V0c2lkZS1iZWZvcmUnfTtcbiAgfVxuXG4gIC8vIGluc2VydCBhIGZha2UgJ2FmdGVyJyBub2RlIHRvIHNlZSBpZiBpdCdzIHNlbGVjdGVkXG4gIHJvb3QuYXBwZW5kQ2hpbGQoZmFrZVNlbGVjdGlvbk5vZGUpO1xuICBjb25zdCBpbmNsdWRlc0FmdGVyUm9vdCA9IHMuY29udGFpbnNOb2RlKGZha2VTZWxlY3Rpb25Ob2RlKTtcbiAgZmFrZVNlbGVjdGlvbk5vZGUucmVtb3ZlKCk7XG4gIGlmIChpbmNsdWRlc0FmdGVyUm9vdCkge1xuICAgIHJldHVybiB7cmFuZ2U6IG51bGwsIG1vZGU6ICdvdXRzaWRlLWFmdGVyJ307XG4gIH1cblxuICBjb25zdCBtZWFzdXJlID0gKCkgPT4gcy50b1N0cmluZygpLmxlbmd0aDtcbiAgY29uc3QgaW5pdGlhbFNlbGVjdGlvbkNvbnRlbnQgPSBzLnRvU3RyaW5nKCk7XG4gIGlmICghKHMudHlwZSA9PT0gJ0NhcmV0JyB8fCBzLnR5cGUgPT09ICdSYW5nZScpKSB7XG4gICAgcmV0dXJuIHtyYW5nZTogbnVsbCwgbW9kZTogJ291dHNpZGUtYWZ0ZXInfTtcbiAgfVxuICBjb25zdCBpbml0aWFsQ2FyZXQgPSAocy50eXBlID09PSAnQ2FyZXQnKTtcblxuICBjb25zdCBsZWZ0Tm9kZSA9IGZpbmROb2RlKHMsIHJvb3QsIHRydWUpO1xuICBsZXQgcmlnaHROb2RlO1xuICBsZXQgaXNOYXR1cmFsRGlyZWN0aW9uID0gdW5kZWZpbmVkO1xuICBpZiAocy50eXBlID09PSAnUmFuZ2UnKSB7XG4gICAgcmlnaHROb2RlID0gZmluZE5vZGUocywgcm9vdCwgZmFsc2UpOyAgLy8gZ2V0IHJpZ2h0IG5vZGUgaGVyZSBfYmVmb3JlXyBnZXRTZWxlY3Rpb25EaXJlY3Rpb25cbiAgICBpc05hdHVyYWxEaXJlY3Rpb24gPSBnZXRTZWxlY3Rpb25EaXJlY3Rpb24ocywgbGVmdE5vZGUsIHJpZ2h0Tm9kZSk7XG4gICAgLy8gaXNOYXR1cmFsRGlyZWN0aW9uIG1lYW5zIFwiZ29pbmcgcmlnaHRcIlxuICB9XG5cbiAgaWYgKHMudHlwZSA9PT0gJ0NhcmV0Jykge1xuICAgIC8vIHdlIG1pZ2h0IHRyYW5zaXRpb24gdG8gYmVpbmcgYSBjYXJldCwgc28gZG9uJ3QgY2hlY2sgaW5pdGlhbCB2YWx1ZVxuICAgIHMuZXh0ZW5kKGxlZnROb2RlLCAwKTtcbiAgICBjb25zdCBhdCA9IG1lYXN1cmUoKTtcbiAgICBzLmNvbGxhcHNlVG9FbmQoKTtcblxuICAgIHJhbmdlLnNldFN0YXJ0KGxlZnROb2RlLCBhdCk7XG4gICAgcmFuZ2Uuc2V0RW5kKGxlZnROb2RlLCBhdCk7XG4gICAgcmV0dXJuIHtyYW5nZSwgbW9kZTogJ2NhcmV0J307XG4gIH0gZWxzZSBpZiAoaXNOYXR1cmFsRGlyZWN0aW9uID09PSB1bmRlZmluZWQpIHtcbiAgICBpZiAocy50eXBlICE9PSAnUmFuZ2UnKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCd1bmV4cGVjdGVkIHR5cGU6ICcgKyBzLnR5cGUpO1xuICAgIH1cbiAgICAvLyBUaGlzIG9jY3VycyB3aGVuIHdlIGNhbid0IG1vdmUgYmVjYXVzZSB3ZSBjYW4ndCBleHRlbmQgbGVmdCBvciByaWdodCB0byBtZWFzdXJlIHRoZVxuICAgIC8vIGRpcmVjdGlvbiB3ZSdyZSBtb3ZpbmcgaW4uIEdvb2QgbmV3cyB0aG91Z2g6IHdlIGRvbid0IG5lZWQgdG8gX2NoYW5nZV8gdGhlIHNlbGVjdGlvblxuICAgIC8vIHRvIG1lYXN1cmUgaXQsIHNvIGp1c3QgcmV0dXJuIGltbWVkaWF0ZWx5LlxuICAgIHJhbmdlLnNldFN0YXJ0KGxlZnROb2RlLCAwKTtcbiAgICByYW5nZS5zZXRFbmQocmlnaHROb2RlLCByaWdodE5vZGUubGVuZ3RoKTtcbiAgICByZXR1cm4ge3JhbmdlLCBtb2RlOiAnYWxsJ307XG4gIH1cblxuICBjb25zdCBzaXplID0gbWVhc3VyZSgpO1xuICBsZXQgb2Zmc2V0TGVmdCwgb2Zmc2V0UmlnaHQ7XG5cbi8vIG9ubHkgb25lIG5ld2xpbmUvc3BhY2UgY2hhciBpcyBjYXJlZCBhYm91dFxuICBjb25zdCB2YWxpZFJpZ2h0TGVuZ3RoID0gcmlnaHROb2RlLmxlbmd0aCAtIGlnbm9yZWRUcmFpbGluZ1NwYWNlKHJpZ2h0Tm9kZSk7XG5cbiAgaWYgKGlzTmF0dXJhbERpcmVjdGlvbikge1xuICAgIC8vIHdhbGsgaW4gdGhlIG9wcG9zaXRlIGRpcmVjdGlvbiBmaXJzdFxuICAgIHMuZXh0ZW5kKGxlZnROb2RlLCAwKTtcbiAgICBvZmZzZXRMZWZ0ID0gbWVhc3VyZSgpICsgaW5pdGlhbFNwYWNlKGxlZnROb2RlKTsgIC8vIG1lYXN1cmUgZG9lc24ndCBpbmNsdWRlIGluaXRpYWwgc3BhY2VcblxuICAgIC8vIHRoZW4gaW4gb3VyIGFjdHVhbCBkaXJlY3Rpb25cbiAgICBzLmV4dGVuZChyaWdodE5vZGUsIHZhbGlkUmlnaHRMZW5ndGgpO1xuICAgIG9mZnNldFJpZ2h0ID0gdmFsaWRSaWdodExlbmd0aCAtIChtZWFzdXJlKCkgLSBzaXplKTtcblxuICAgIC8vIHRoZW4gcmV2ZXJ0IHRvIHRoZSBvcmlnaW5hbCBwb3NpdGlvblxuICAgIHMuZXh0ZW5kKHJpZ2h0Tm9kZSwgb2Zmc2V0UmlnaHQpO1xuICB9IGVsc2Uge1xuICAgIC8vIHdhbGsgaW4gdGhlIG9wcG9zaXRlIGRpcmVjdGlvbiBmaXJzdFxuICAgIHMuZXh0ZW5kKHJpZ2h0Tm9kZSwgdmFsaWRSaWdodExlbmd0aCk7XG4gICAgb2Zmc2V0UmlnaHQgPSB2YWxpZFJpZ2h0TGVuZ3RoIC0gbWVhc3VyZSgpO1xuXG4gICAgLy8gdGhlbiBpbiBvdXIgYWN0dWFsIGRpcmVjdGlvblxuICAgIHMuZXh0ZW5kKGxlZnROb2RlLCAwKTtcbiAgICBvZmZzZXRMZWZ0ID0gbWVhc3VyZSgpIC0gc2l6ZSArIGluaXRpYWxTcGFjZShsZWZ0Tm9kZSk7ICAvLyBkb2Vzbid0IGluY2x1ZGUgaW5pdGlhbCBzcGFjZVxuXG4gICAgLy8gdGhlbiByZXZlcnQgdG8gdGhlIG9yaWdpbmFsIHBvc2l0aW9uXG4gICAgcy5leHRlbmQobGVmdE5vZGUsIG9mZnNldExlZnQpO1xuICB9XG5cbiAgaWYgKGRlYnVnKSB7XG4gICAgaWYgKGxlZnROb2RlID09PSByaWdodE5vZGUpIHtcbiAgICAgIGNvbnNvbGUuaW5mbygnZ290IHN0cmluZycsIGxlZnROb2RlLnRleHRDb250ZW50LnN1YnN0cihvZmZzZXRMZWZ0LCBvZmZzZXRSaWdodCAtIG9mZnNldExlZnQpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5pbmZvKCc+Pj4gc3RyaW5nJywgbGVmdE5vZGUudGV4dENvbnRlbnQuc3Vic3RyKG9mZnNldExlZnQpKTtcbiAgICAgIGNvbnNvbGUuaW5mbygnPDw8IHN0cmluZycsIHJpZ2h0Tm9kZS50ZXh0Q29udGVudC5zdWJzdHIoMCwgb2Zmc2V0UmlnaHQpKTtcbiAgICB9XG4gIH1cblxuICByYW5nZS5zZXRTdGFydChsZWZ0Tm9kZSwgb2Zmc2V0TGVmdCk7XG4gIHJhbmdlLnNldEVuZChyaWdodE5vZGUsIG9mZnNldFJpZ2h0KTtcbiAgcmV0dXJuIHtcbiAgICBtb2RlOiBpc05hdHVyYWxEaXJlY3Rpb24gPyAncmlnaHQnIDogJ2xlZnQnLFxuICAgIHJhbmdlLFxuICB9O1xufVxuIl19