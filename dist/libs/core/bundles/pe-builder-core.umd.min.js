!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("rxjs"),require("lodash-es"),require("uuid")):"function"==typeof define&&define.amd?define("@pe/builder-core",["exports","@angular/core","rxjs","lodash-es","uuid"],t):t(((e=e||self).pe=e.pe||{},e.pe["builder-core"]={}),e.ng.core,e.rxjs,e["lodash-es"],e.uuid)}(this,(function(e,t,n,r,o){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var a,i,c,l,p,f,u,d,s,h,b=function(){return(b=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function m(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,a=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(r=a.next()).done;)i.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=a.return)&&n.call(a)}finally{if(o)throw o.error}}return i}function P(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(m(arguments[t]));return e}(a=e.PebEffectTarget||(e.PebEffectTarget={})).Shop="shop",a.Pages="pages",a.Templates="templates",a.Stylesheets="stylesheets",a.ContextSchemas="contextSchemas",(i=e.PebShopEffect||(e.PebShopEffect={})).Init="shop:init",i.UpdateData="shop:update-data",i.UpdatePages="shop:update-pages",i.AppendPage="shop:append-page",i.DeletePage="shop:delete-page",(c=e.PebPageEffect||(e.PebPageEffect={})).Create="page:init",c.UpdateData="page:update-data",c.Delete="page:delete",(l=e.PebTemplateEffect||(e.PebTemplateEffect={})).Init="template:init",l.Destroy="template:destroy",l.AppendElement="template:append-element",l.UpdateElement="template:update-element",l.RelocateElement="template:relocate-element",l.DeleteElement="template:delete-element",(p=e.PebStylesheetEffect||(e.PebStylesheetEffect={})).Init="stylesheet:init",p.Update="stylesheet:update",p.Delete="stylesheet:delete",(f=e.PebContextSchemaEffect||(e.PebContextSchemaEffect={})).Init="context-schema:init",f.Update="context-schema:update",f.Delete="context-schema:delete",(d=e.PebPageType||(e.PebPageType={})).Master="master",d.Replica="replica",(s=e.PebPageVariant||(e.PebPageVariant={})).Front="front",s.Default="default",s.Category="category",s.Product="product",(h=e.ContextService||(e.ContextService={})).Company="company",h.Products="products",h.Shipments="shipments";var g,y,E,S=((u={})[e.ContextService.Company]=new t.InjectionToken("ContextServices.Company"),u[e.ContextService.Products]=new t.InjectionToken("ContextServices.Products"),u[e.ContextService.Shipments]=new t.InjectionToken("ContextServices.Shipments"),u);(g=e.PebElementType||(e.PebElementType={})).Document="document",g.Section="section",g.Block="block",g.Text="text",g.Image="image",g.Product="product",g.ProductPage="productPage",g.Button="button",g.Cart="cart",g.Shape="shape",g.Carousel="carousel",g.Amount="amount",g.Logo="logo",g.Products="shop-products",g.Line="line",(e.PebMakerType||(e.PebMakerType={})).Text="text",(y=e.PebElementContextState||(e.PebElementContextState={})).Loading="loading",y.Error="error",y.Ready="ready",y.Empty="empty",(E=e.PebScreen||(e.PebScreen={})).Desktop="desktop",E.Tablet="tablet",E.Mobile="mobile";var v=function(){function e(){this.destroyed$=new n.ReplaySubject}return e.prototype.ngOnDestroy=function(){this.destroyed$.next(!0),this.destroyed$.complete()},e.ɵfac=function(t){return new(t||e)},e.ɵdir=t["ɵɵdefineDirective"]({type:e}),e}(),T=function(){},x="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||this;function C(e,t){var n=t(e),o=n.children,a=void 0===o?[]:o,i=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}(n,["children"]);return b(b({},r.merge({},i)),{children:a.map((function(e){return C(e,t)}))})}function I(e,t){var n,o,a=null===(n=e.children)||void 0===n?void 0:n.filter(t);return b(b({},r.merge({},e)),{children:null===(o=a)||void 0===o?void 0:o.map((function(e){return I(e,t)}))})}function D(e,t){t(r.merge({},e)),r.isArray(e.children)&&e.children.forEach((function(e){return D(e,t)}))}function w(e,t,n,o){void 0===n&&(n=null),void 0===o&&(o=-1);var a=parseInt(o,10)+1;t(b(b({},e),{parentId:n,priority:a})),r.isArray(e.children)&&e.children.forEach((function(n){return w(n,t,e.id,a)}))}var j,k="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||this;function O(e){if(k.PEB_CUSTOM_IDS){return Number(r.random(0,Math.pow(36,5)-1)).toString(36)}return o.v4()}var U,A=((j={})[e.PebContextSchemaEffect.Init]=function(e,t){return t},j[e.PebContextSchemaEffect.Update]=function(e,t){return r.merge({},e,t)},j[e.PebContextSchemaEffect.Delete]=function(e,t){return null},j);var M,B=((U={})[e.PebPageEffect.Create]=function(e,t){return t},U[e.PebPageEffect.UpdateData]=function(e,t){return b(b({},e),{data:b(b({},e.data),t)})},U[e.PebPageEffect.Delete]=function(e,t){return null},U);var F,R=((M={})[e.PebShopEffect.Init]=function(e,t){return t},M[e.PebShopEffect.UpdateData]=function(e,t){return b(b({},e),{data:b(b({},e.data),t)})},M[e.PebShopEffect.UpdatePages]=function(e,t){return b(b({},e),{pageIds:t})},M[e.PebShopEffect.AppendPage]=_,M[e.PebShopEffect.DeletePage]=_,M);function _(e,t){return b(b({},e),{pageIds:P(e.pageIds,[t])})}var L,q=((F={})[e.PebStylesheetEffect.Init]=function(e,t){return t},F[e.PebStylesheetEffect.Update]=function(e,t){return r.merge({},e,t)},F[e.PebStylesheetEffect.Delete]=function(){return null},F);var V=((L={})[e.PebTemplateEffect.Init]=function(e,t){return t},L[e.PebTemplateEffect.Destroy]=function(e){return null},L[e.PebTemplateEffect.AppendElement]=function(e,t){return C(e,(function(e){return e.id===t.to?b(b({},e),{children:P(e.children,[t.element])}):e}))},L[e.PebTemplateEffect.UpdateElement]=function(e,t){throw new Error("To implement")},L[e.PebTemplateEffect.RelocateElement]=function(e,t){throw new Error("To implement")},L[e.PebTemplateEffect.DeleteElement]=function(e,t){return I(e,(function(e){return e.id!==t}))},L);var G=b(b(b(b(b({},R),B),V),q),A);function N(t,n){return n.effects.reduce((function(t,n){var o,a,i=m(n.target.split(":"),2),c=i[0],l=i[1],p=G[n.type];if(!p)throw new Error("Invalid effect type");var f=Object.values(e.PebEffectTarget);if(c===e.PebEffectTarget.Shop)return b(b({},t),{shop:p(t.shop,n.payload)});if(f.includes(c)){var u=p(t[c][l]||null,n.payload),d=Boolean(u)?b(b({},t[c]),((o={})[l]=u,o)):r.omit(t[c],l);return b(b({},t),((a={})[c]=d,a))}throw new Error("Invalid effect target")}),t)}var $=function(t,n,o){var a,i,c,l;void 0===n&&(n=e.PebPageType.Replica),void 0===o&&(o=e.PebPageVariant.Default);var p=O(),f=(e.PebElementType.Line,{id:O(),type:e.PebElementType.Document,children:["header","body","footer"].map((function(n){return{id:O(),type:e.PebElementType.Section,data:{name:n},meta:{deletable:!1},children:P("header"===n?[{id:O(),type:e.PebElementType.Block,children:[{id:O(),type:e.PebElementType.Text,data:{text:t}}]}]:[])}}))}),u=m(f.children.map((function(e){return e.id})),3),d=u[0],s=u[1],h=u[2],b=f.children[0].children[0].id,g="#"+Number(r.random(0,Math.pow(16,6))).toString(16);return{id:O(),name:t,type:n,variant:o,master:null,data:{url:"/",mark:null},template:f,stylesheets:(a={},a[e.PebScreen.Desktop]=(i={},i[d]={height:200},i[s]={height:600},i[h]={height:200},i[b]={height:150,width:150,backgroundColor:g},i[p]={height:2},i),a[e.PebScreen.Tablet]=(c={},c[d]={height:200},c[s]={height:600},c[h]={height:200},c[b]={height:150,width:150,backgroundColor:g},c[p]={height:2},c),a[e.PebScreen.Mobile]=(l={},l[d]={height:200},l[s]={height:600},l[h]={height:200},l[b]={height:150,width:150,backgroundColor:g},l[p]={height:2},l),a),context:{}}};e.AbstractComponent=v,e.CONTEXT_SERVICES=S,e.PebApiService=T,e.pebActionHandler=N,e.pebCompileActions=function(e){return e.reduce(N,{id:null,shop:null,pages:{},templates:{},stylesheets:{},contextSchemas:{}})},e.pebCreateElementKit=function(e,t,n){var r,o=b(b({},e),{id:O()});return{element:o,styles:t,contextSchema:(r={},r[o.id]=n,r)}},e.pebCreateEmptyPage=$,e.pebCreateEmptyShop=function(){var e=$("Front");return{id:O(),data:{frontPageId:e.id},routing:{"/":e.id},context:{},pages:[e]}},e.pebCreateLogger=function(e){var t=P(e.split(":").map((function(e,t,n){return P(n.slice(0,t),["*"]).join(":")})),[e]);return x.PEB_DEBUG&&x.PEB_DEBUG.split(",").find((function(e){return t.includes(e)}))?function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return console.log.apply(console,P(["%c "+e+" ","background: #3078a8; color: white"],t)),P(t)}:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return P(e)}},e.pebCreateShopInitAction=function(t){var n,r,o=t.pages[0],a=O(),i=O(),c=((n={})[e.PebScreen.Desktop]=O(),n[e.PebScreen.Tablet]=O(),n[e.PebScreen.Mobile]=O(),n),l=O();return{id:O(),createdAt:new Date,effects:P([{type:e.PebTemplateEffect.Init,target:e.PebEffectTarget.Templates+":"+i,payload:o.template}],Object.values(e.PebScreen).map((function(t){return{type:e.PebStylesheetEffect.Init,target:e.PebEffectTarget.Stylesheets+":"+c[t],payload:o.stylesheets[t]}})),[{type:e.PebContextSchemaEffect.Init,target:e.PebEffectTarget.ContextSchemas+":"+l,payload:o.context},{type:e.PebPageEffect.Create,target:e.PebEffectTarget.Pages+":"+o.id,payload:{id:o.id,type:o.type,variant:o.variant,master:o.master,name:o.name,data:o.data,templateId:i,stylesheetIds:(r={},r[e.PebScreen.Desktop]=""+c[e.PebScreen.Desktop],r[e.PebScreen.Tablet]=""+c[e.PebScreen.Tablet],r[e.PebScreen.Mobile]=""+c[e.PebScreen.Mobile],r),contextId:""+l}},{type:e.PebContextSchemaEffect.Init,target:e.PebEffectTarget.ContextSchemas+":"+a,payload:{}},{type:e.PebShopEffect.Init,target:e.PebEffectTarget.Shop,payload:{data:{frontPageId:o.id},contextId:a,pageIds:[o.id]}}])}},e.pebFilterElementDeep=I,e.pebFindElementChildren=function(e,t){if(t&&!r.isFunction(t))throw new Error("Unsupported selector");t=t||function(){return!0};var n=[];return D(e,(function(e){t(e)&&n.push(e)})),n},e.pebFindElementChildrenWithParent=function(e,t){if(void 0===t&&(t=function(){return!0}),t&&!r.isFunction(t))throw new Error("Unsupported selector");var n=[];return w(e,(function(e){t(e)&&n.push(e)})),n},e.pebFindElementParents=function(e,t){for(var n=[{node:e,i:0}];n.length;){for(var r=n[n.length-1];r.i<r.node.children.length;){var o=r.node.children[r.i];if(o.id===t)return n.filter((function(t){return t.node.id!==e.id})).map((function(e){return e.node}));n.push({node:o,i:0}),r.i++,r=n[n.length-1]}n.pop()}return null},e.pebGenerateId=O,e.pebMapElementDeep=C,e.pebTraverseElementDeep=D,e.pebTraverseElementDeepWithParent=w,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=pe-builder-core.umd.min.js.map